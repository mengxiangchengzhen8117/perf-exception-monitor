!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e="undefined"!=typeof globalThis?globalThis:e||self).PerfExceptionMonitor=n()}(this,(function(){"use strict";function e(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function n(n){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?e(Object(r),!0).forEach((function(e){a(n,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):e(Object(r)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(r,e))}))}return n}function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function o(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,c(r.key),r)}}function i(e,n,t){return n&&o(e.prototype,n),t&&o(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function a(e,n,t){return(n=c(n))in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function c(e){var n=function(e,n){if("object"!=typeof e||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,n||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"==typeof n?n:String(n)}var s={formatDate:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Date,t={"M+":n.getMonth()+1,"D+":n.getDate(),"h+":n.getHours(),"m+":n.getMinutes(),"s+":n.getSeconds(),s:n.getMilliseconds(),z:n.getTimezoneOffset()};for(var r in/(Y+)/.test(e)&&(e=e.replace(RegExp.$1,(n.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+r+")").test(e)&&(e=e.replace(RegExp.$1,1===RegExp.$1.length?t[r]:("00"+t[r]).substr((""+t[r]).length)));return e}},f=function(){function e(){r(this,e)}return i(e,[{key:"setConfig",value:function(n){Object.assign(e.cacheConfig,n||{})}},{key:"sendException",value:function(t){var r=JSON.parse(JSON.stringify(t));if(r&&r.extra&&"string"==typeof r.extra)try{r.extra=JSON.parse(r.extra)}catch(e){r.extra={}}var o=Object.assign({url:location.href},r.extra||{});o.url=o.url?o.url:location.href,delete r.extra,this.send(e.cacheConfig.exceptioinEventName,n(n({},r),{},{warn_info:"捕获到错误信息",class_func_line:"logger_sendException_0",date:s.formatDate("YYYY-MM-DD hh:mm:ss.S Z")},o))}},{key:"sendPerformance",value:function(t){var r=JSON.parse(JSON.stringify(t));if(r&&r.extra&&"string"==typeof r.extra)try{r.extra=JSON.parse(r.extra)}catch(e){r.extra={}}var o=Object.assign({url:location.href},r.extra||{});delete r.extra,o.url=o.url?o.url:location.href,this.send(e.cacheConfig.performanceEventName,n(n({},r),o))}},{key:"send",value:function(e,n){for(var t in console.info("🚀🚀🚀 ".concat(e,":\n")),n){var r=Object.prototype.toString.call(n[t]);if("[object Object]"==r||"[object Array]"==r){var o="[object Object]"==r?["{","}"]:["[","]"];for(var i in console.info("  ".concat(t,": ").concat(o[0],"\n")),n[t])console.info("    ".concat(i,": ").concat(JSON.stringify(n[t][i]),",\n"));console.info("  ".concat(o[1],",\n"))}else console.info("  ".concat(t,": ").concat(n[t],",\n"))}console.info("🚀🚀🚀 end\n")}}]),e}();a(f,"cacheConfig",{exceptioinEventName:"异常数据",performanceEventName:"性能数据"});var u,l=new f,p=function(){function e(){r(this,e),this.vueErrorHandler=this.vueErrorHandler.bind(this),this.run=this.run.bind(this)}return i(e,[{key:"run",value:function(){var e=arguments,t=this,r=window.onerror;window.onerror=function(o,i,a,c,s){try{var f;"function"==typeof r&&r.apply(window,Array.prototype.slice.call(e));var u=o?o.toLowerCase():"";f=u.indexOf("script error")>-1?{warn_info:"crossorigin: Script Error",extra:{type:"Error",triggerType:"onerror",message:o,errObj:s?JSON.stringify(s):""}}:{warn_info:o,class_func_line:a,stack:s&&s.stack?s.stack.toString():"",extra:{type:"Error",url:i||"",colNo:c||"",triggerType:"onerror",errObj:s?JSON.stringify(s):""}};var l=Object.assign({type:"Unknow",triggerType:"onunhandledrejection"},f.extra);delete f.extra,t.send(n({warn_info:"捕获到错误信息",class_func_line:"",extra:l},f))}catch(e){}};var o=window.onunhandledrejection;window.onunhandledrejection=function(n){try{"function"==typeof o&&o.apply(window,Array.prototype.slice.call(e)),t.promiseRejectionHandler(n)}catch(e){}}}},{key:"vueErrorHandler",value:function(e){if(e){var n={warn_info:e.message||"捕获到错误信息",class_func_line:"",stack:e.stack?e.stack.toString():"",extra:{type:"Error",triggerType:"VueErrorHandler",errObj:JSON.stringify(e)}};this.send(n)}}},{key:"send",value:function(e){var t=n({warn_info:"捕获到错误信息",class_func_line:""},e);l.sendException(t)}},{key:"captureException",value:function(e){if(e){var t;if(e instanceof ErrorEvent&&e.error)t={warn_info:e.message||"ErrorEvent",class_func_line:e.lineno||"",stack:e.error&&e.error.stack?e.error.stack.toString():"",extra:{type:"ErrorEvent",colNo:e.colno||"",fileName:e.filename||"",errObj:JSON.stringify(e.error)}};else if(e instanceof DOMException){var r=e.name||"DOMException";t={warn_info:e.message?"".concat(r,":").concat(e.message):r,extra:{type:r}}}else if(e instanceof Error){var o=e.name||"Error";t={warn_info:e.message?"".concat(o,":").concat(e.message):o,class_func_line:e.lineNumber||"",stack:e.error&&e.error.stack?e.error.stack.toString():"",extra:{type:o,colNo:e.columnNumber||"",fileName:e.filename||""}}}else e instanceof PromiseRejectionEvent?t={warn_info:"PromiseRejection: "+JSON.stringify(e.reason),extra:{type:"PromiseRejection"}}:this.isPlainObject(e)&&(t={warn_info:this.getCaptureExceptionOptions(e),extra:{type:"ErrorEvent",errObj:JSON.stringify(e)}});var i=Object.assign({type:"Unknow",triggerType:"onunhandledrejection"},t.extra);delete t.extra,this.send(n({warn_info:"捕获到错误信息",class_func_line:"",extra:i},t))}}},{key:"promiseRejectionHandler",value:function(e){this.captureException(e)}},{key:"getCaptureExceptionOptions",value:function(e){var n=Object.keys(e).sort();return"Non-Error exception captured with keys:"+JSON.stringify(n)}},{key:"isPlainObject",value:function(e){if("object"!==t(e)||null===e)return!1;for(var n=e;null!==Object.getPrototypeOf(n);)n=Object.getPrototypeOf(n);return Object.getPrototypeOf(e)===n}},{key:"handleError",value:function(e){try{if(e&&e.stack){var n=e.stack.match("https?://[^\n]+"),t=(n=n?n[0]:"").match(":(\\d+):(\\d+)");return t||(t=[0,0,0]),{msg:e.stack,line:t[1],col:t[2],fileUrl:n.replace(t[0],"").replace(")",""),stack:e.stack}}return e}catch(n){return e}}}]),e}(),m=function(){function e(){r(this,e),this.performanceTiming={timing:{},memory:{},entries:{}}}return i(e,[{key:"run",value:function(){this.getPerformanceData()}},{key:"getPerformanceData",value:function(){var e=this;this.getPerformanceTiming(),this.getPerformanceMemory(),this.getPerformanceEntries(),setTimeout((function(){e.send()}),1e3)}},{key:"getPerformanceTiming",value:function(){var e=this;if(window.performance&&window.performance.timing){var n=window.performance.timing,t={};if(t.redirect_time=n.redirectEnd-n.redirectStart,t.domain_lookup=n.domainLookupEnd-n.domainLookupStart,t.tcp_connect=n.connectEnd-n.connectStart,t.assert_request=n.responseEnd-n.requestStart,t.dom_resolve=n.domInteractive-n.domLoading,t.dom_complete=n.domComplete-n.domInteractive,t.load=n.domComplete-n.responseEnd,t.white=n.domComplete-n.navigationStart,Object.assign(this.performanceTiming.timing,t),window.PerformanceObserver)try{var r=new PerformanceObserver((function(n){var t=n.getEntries();if(t&&t.length&&t[t.length-1]){var r=t[t.length-1],o=r.renderTime||r.loadTime;Object.assign(e.performanceTiming.timing,{lcp:o})}}));"function"==typeof r.observe&&r.observe({type:"largest-contentful-paint"})}catch(e){console.error(e)}}}},{key:"getPerformanceMemory",value:function(){if(window.performance&&window.performance.memory){var e={jsHeapSizeLimit:window.performance.memory.jsHeapSizeLimit,totalJSHeapSize:window.performance.memory.totalJSHeapSize,usedJSHeapSize:window.performance.memory.usedJSHeapSize};Object.assign(this.performanceTiming.memory,e)}}},{key:"getPerformanceEntries",value:function(){if(window.performance&&window.performance.getEntries){var e=window.performance.getEntries(),n=e.filter((function(e){return e&&("link"===e.initiatorType||"script"===e.initiatorType)})),t={},r=[],o=[];n.forEach((function(e){e&&e.duration>5e3&&r.push("name: ".concat(e.name,", duration: ").concat(e.duration)),e&&e.transferSize>2e6&&o.push("name: ".concat(e.name,", transferSize: ").concat(e.transferSize))})),r.length&&(t["资源加载时间超限duration>5000"]=r.join("; ")),o.length&&(t["资源加载大小超限transferSize>2000000"]=o.join("; ")),Object.assign(this.performanceTiming.entries,t);var i=e.reduce((function(e,n){return"img"===n.initiatorType?e.img_count=e.img_count?e.img_count+1:1:"script"===n.initiatorType?e.js_count=e.js_count?e.js_count+1:1:"link"===n.initiatorType&&n.name.endsWith(".css")&&(e.css_count=e.css_count?e.css_count+1:1),e}),{});Object.assign(this.performanceTiming.entries,i)}}},{key:"send",value:function(){l.sendPerformance(this.performanceTiming)}}]),e}(),g=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,e),this.config=Object.assign({fpsEnable:!0,fpsMin:20},n),this.config.fpsMin=Number(this.config.fpsMin),this.config.fpsMin=Math.min(this.config.fpsMin,60),this.config.fpsMin=Math.max(this.config.fpsMin,0),this.config.fpsEnable=!0===this.config.fpsEnable}return i(e,[{key:"run",value:function(){var e=this;!u&&this.config.fpsEnable&&setTimeout((function(){e.startLoop()}),1e4)}},{key:"startLoop",value:function(){var e=this,n=window.requestAnimationFrame||window.webkitRequestAnimationFrame;if(n&&performance){var t=performance.now(),r=0,o=performance.now(),i=[],a=0;!function c(){var s=performance.now(),f=s-o;o=s;var l=Math.round(1e3/f);r++,s>1e3+t&&(l=Math.round(1e3*r/(s-t)),r=0,t=s),i.push(l),i.length>3&&i.splice(0,i.length-3);var p=e.isLowFPS(i,e.config.fpsMin,3);if(p.isLow){i.splice(0,i.length);var m=(new Date).getTime();(!a||m-a>6e5)&&(a=m,e.send({fps:p.middleValue}))}u=n(c)}()}}},{key:"isLowFPS",value:function(e,n,t){var r=!1,o=0;if(e.length>=t)for(var i=0,a=0,c=0;c<e.length;c++)if(e[c]<n?(a+=e[c],i++):(a=0,i=0),i>=t){r=!0,o=i?Math.round(a/i):0;break}return{isLow:r,middleValue:o}}},{key:"send",value:function(e){e&&l.sendPerformance({fps:e.fps})}}]),e}();Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("It is not a function.");var n="object"===t(e)?e:window,r=Array.prototype.slice.call(arguments,1),o=this,i=function(){return o.apply(this instanceof o?this:n,r.concat(Array.prototype.slice.call(arguments)))};function a(){}return a.prototype=this.prototype,i.prototype=new a,i});var y=function(){function e(){r(this,e),a(this,"ExceptionInstance",null),a(this,"PerformanceInstance",null),a(this,"FPSInstance",null)}return i(e,[{key:"init",value:function(e){var n=arguments,t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(r=r||{},l.setConfig(r),!1!==r.enableMonitor){this.runExceptionMonitor(r);var o=window.onload;window.onload=function(){"function"==typeof o&&o.apply(window,Array.prototype.slice.call(n)),t.runPerformanceMonitor(r),t.runFPSMonitor(r)},this.ExceptionInstance&&(e.config.errorHandler=this.ExceptionInstance.vueErrorHandler)}}},{key:"runExceptionMonitor",value:function(){this.ExceptionInstance=new p,this.ExceptionInstance.run()}},{key:"runPerformanceMonitor",value:function(){this.PerformanceInstance=new m,this.PerformanceInstance.run()}},{key:"runFPSMonitor",value:function(e){this.FPSInstance=new g(e),this.FPSInstance.run()}}]),e}();return{install:function(e,n){(new y).init(e,n)}}}));
